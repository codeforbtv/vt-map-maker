var VTMM=VTMM||{};VTMM.map={};VTMM.init=function(){queue().defer(d3.json,"static/data/vt.json").defer(d3.csv,"https://docs.google.com/spreadsheet/pub?key=0AtWnpcGxoF0xdFhOLUFDRGRURUpOWktwTDd4alJhVGc&output=csv").await(VTMM.map.loadData)};VTMM.map.options={width:$("#map").width(),height:$("#map").height(),colorRange:colorbrewer.YlGn[8],selectedField:"wage"};VTMM.map.svg=d3.select("#map").append("svg").attr("width",VTMM.map.options.width).attr("height",VTMM.map.options.height);VTMM.map.projection=d3.geo.transverseMercator().rotate([72.57,-44.2]).translate([VTMM.map.options.width/2.5,VTMM.map.options.height/2.75]).scale([VTMM.map.options.height*23]);VTMM.map.path=d3.geo.path().projection(VTMM.map.projection);VTMM.map.getDomain=function(e){var t=VTMM.map.data.objects.vt_towns.geometries;return $.map(t,function(t){return parseFloat(t.properties[e])})};VTMM.map.getScale=function(){return d3.scale.quantile().domain(VTMM.map.domain.sort()).range(VTMM.map.options.colorRange)};VTMM.legend={};VTMM.legend.y=function(){return d3.scale.linear().domain([VTMM.map.minValue,VTMM.map.maxValue]).range([0,VTMM.map.options.height-80])};VTMM.legend.yAxis=function(){var e=VTMM.legend.colorScale().domain;e.push(VTMM.map.maxValue);e.unshift(VTMM.map.minValue);return d3.svg.axis().scale(VTMM.legend.y()).tickValues(e).orient("right")};VTMM.legend.options={width:6};VTMM.legend.colorScale=function(){var e=VTMM.map.getScale().quantiles();return{domain:e,range:VTMM.map.options.colorRange}};VTMM.map.loadData=function(e,t,n){var r=Object.keys(n[0]).pop();for(var i=0;i<n.length;i++){var s=n[i].town.toUpperCase();for(var o=0;o<t.objects.vt_towns.geometries.length;o++){var u=t.objects.vt_towns.geometries[o].properties.town;s==u&&(t.objects.vt_towns.geometries[o].properties[r]=n[i][r])}}VTMM.data=n;VTMM.map.data=t;VTMM.map.domain=VTMM.map.getDomain(r).filter(Number);VTMM.map.maxValue=Math.max.apply(Math,VTMM.map.domain);VTMM.map.minValue=Math.min.apply(Math,VTMM.map.domain);VTMM.map.render(r)};VTMM.map.render=function(e){var t=VTMM.map.data;VTMM.map.currentScale=VTMM.map.getScale();VTMM.map.svg.selectAll(".town").data(topojson.feature(t,t.objects.vt_towns).features).enter().append("path").attr("d",VTMM.map.path).attr("class","town").style("fill",VTMM.map.fillFunc).on("mouseover",function(t){var n=d3.mouse(this)[0],r=d3.mouse(this)[1]-30;VTMM.map.svg.append("text").attr("id","tooltip").attr("x",n).attr("y",r).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","11px").attr("font-weight","bold").attr("fill","black").text(t.properties.town+" "+e+":"+t.properties[e]);d3.select(this).style("fill","#ef6548")}).on("mouseout",function(e){d3.select("#tooltip").remove();d3.select(this).style("fill",VTMM.map.fillFunc)}).on("click",function(e){var t=slugify(e.properties.town);VTMM.select_town(t)});VTMM.map.svg.append("g").attr("class","key").attr("transform","translate("+(VTMM.map.options.width-80)+",35)").call(VTMM.legend.yAxis(e)).selectAll("rect").data(VTMM.legend.colorScale(e).range.map(function(t,n){var r=VTMM.legend.colorScale(e).domain,i=VTMM.legend.y();return{y0:n?i(r[n-1]):i.range()[0],y1:n<r.length?i(r[n]):i.range()[1],z:t}})).enter().append("rect").attr("width",VTMM.legend.options.width).attr("y",function(e){return e.y0}).attr("height",function(e){return e.y1-e.y0}).style("fill",function(e){return e.z});VTMM.map.svg.append("path").datum(topojson.feature(t,t.objects.lake)).attr("d",VTMM.map.path).style("stroke","#89b6ef").style("stroke-width","1px").style("fill","#b6d2f5")};VTMM.map.fillFunc=function(e){var t=VTMM.map.options.selectedField,n=e.properties[t];return n?VTMM.map.currentScale(n):"#ddd"};$(document).ready(function(){VTMM.init()});