var VTMM=VTMM||{};VTMM.map={};VTMM.init=function(){queue().defer(d3.json,"static/data/vt.json").defer(d3.csv,"https://docs.google.com/spreadsheet/pub?key=0AtWnpcGxoF0xdFhOLUFDRGRURUpOWktwTDd4alJhVGc&output=csv").await(VTMM.map.loadData)};VTMM.map.options={width:$("#map").width(),height:$("#map").height(),colorRange:colorbrewer.YlGn[7],selectedField:"wage"};VTMM.map.svg=d3.select("#map").append("svg").attr("width",VTMM.map.options.width).attr("height",VTMM.map.options.height);VTMM.map.projection=d3.geo.transverseMercator().rotate([72.57,-44.2]).translate([VTMM.map.options.width/2.5,VTMM.map.options.height/2.75]).scale([VTMM.map.options.height*23]);VTMM.map.path=d3.geo.path().projection(VTMM.map.projection);VTMM.map.getDomain=function(e){var t=VTMM.map.data.objects.vt_towns.geometries;return $.map(t,function(t){return t.properties[e]})};VTMM.map.getScale=function(e){return d3.scale.linear().domain(VTMM.map.getDomain(e)).range(VTMM.map.options.colorRange)};VTMM.map.maxValue=0;VTMM.legend={};VTMM.legend.y=function(){return d3.scale.linear().domain([0,VTMM.map.maxValue]).range([0,VTMM.map.options.height-80])};VTMM.legend.yAxis=function(e){return d3.svg.axis().scale(VTMM.legend.y()).tickValues(VTMM.legend.colorScale(e).domain).orient("right")};VTMM.legend.options={width:6};VTMM.legend.colorScale=function(e){var t=VTMM.map.maxValue,n=[0,t/6,t/3,t/2,2*t/3,5*t/6,t];return{domain:n.sort(function(e,t){return e-t}),range:VTMM.map.options.colorRange}};VTMM.map.loadData=function(e,t,n){for(var r=0;r<n.length;r++){var i=VTMM.map.options.selectedField,s=n[r].town.toUpperCase();VTMM.map.maxValue=parseInt(n[r][i],10)>parseInt(VTMM.map.maxValue,10)?n[r][i]:VTMM.map.maxValue;for(var o=0;o<t.objects.vt_towns.geometries.length;o++){var u=t.objects.vt_towns.geometries[o].properties.town;s==u&&(t.objects.vt_towns.geometries[o].properties[i]=n[r][i])}}VTMM.data=n;VTMM.map.data=t;VTMM.map.render()};VTMM.map.render=function(){var e=VTMM.map.data,t=VTMM.map.options.selectedField;VTMM.map.currentScale=VTMM.map.getScale(t);VTMM.map.svg.selectAll(".town").data(topojson.feature(e,e.objects.vt_towns).features).enter().append("path").attr("d",VTMM.map.path).attr("class","town").style("fill",VTMM.map.fillFunc).on("mouseover",function(e){var n=d3.mouse(this)[0],r=d3.mouse(this)[1]-30;VTMM.map.svg.append("text").attr("id","tooltip").attr("x",n).attr("y",r).attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","11px").attr("font-weight","bold").attr("fill","black").text(e.properties.town+e.properties[t]);d3.select(this).style("fill","#ef6548")}).on("mouseout",function(e){d3.select("#tooltip").remove();d3.select(this).style("fill",VTMM.map.fillFunc)}).on("click",function(e){var t=slugify(e.properties.town);VTMM.select_town(t)});VTMM.map.svg.append("g").attr("class","key").attr("transform","translate("+(VTMM.map.options.width-80)+",35)").call(VTMM.legend.yAxis(t)).selectAll("rect").data(VTMM.legend.colorScale(t).range.map(function(e,n){var r=VTMM.legend.colorScale(t).domain,i=VTMM.legend.y();return{y0:n?i(r[n-1]):i.range()[0],y1:n<r.length?i(r[n]):i.range()[1],z:e}})).enter().append("rect").attr("width",VTMM.legend.options.width).attr("y",function(e){return e.y0}).attr("height",function(e){console.log(e);return e.y1-e.y0}).style("fill",function(e){return e.z});VTMM.map.svg.append("path").datum(topojson.feature(e,e.objects.lake)).attr("d",VTMM.map.path).style("stroke","#89b6ef").style("stroke-width","1px").style("fill","#b6d2f5")};VTMM.map.fillFunc=function(e){var t=VTMM.map.options.selectedField,n=e.properties[t];return n?VTMM.map.currentScale(n):"#ddd"};$(document).ready(function(){VTMM.init()});